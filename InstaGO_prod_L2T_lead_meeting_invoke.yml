AWSTemplateFormatVersion: '2010-09-09'
Description: "InstaGO prod L2T layer lead meeting invoke CFT"
Parameters:
  LambdaFunctionName: 
    Type: String
    Description: Name of the Lambda Function to be created
    Default: InstaGO_prod_L2T_lead_meeting_invoke
  tagenvironment:
    Type: String
    Description: This is tagenvironment
    Default: Production
  table1:
    Type: String
    Description: Name of dynamoDB table 1
    Default: InstaGO_prod_l1_lead_details
  table2:
    Type: String
    Description: Name of dynamoDB table 2
    Default: InstaGO_prod_l2_meeting_details
  table3:
    Type: String
    Description: Name of dynamoDB table 3
    Default: InstaGO_prod_h1_lead_details  
  sourcecodebucketname:
    Type: String
    Description: sourcecodebucketname
    Default: github-actions-1-dmo
  sourcecodebucketkey:
    Type: String
    Description: sourcecodebucketkey
    Default: lambda_2/InstaGO_prod_L2T_lead_meeting_invoke.zip	
  dynamostackname:
    Type: String
    Description: dynamostackname  
    Default: InstaGO-prod-l1-lead-meeting-ddb  
Resources:
  MyRole: 
    Type: "AWS::IAM::Role"
    Properties: 
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Principal: 
              Service: 
                - "lambda.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
      Path: "/"
      RoleName: !Join 
            - ''
            - - !Ref LambdaFunctionName
              - _LambdaRole
      Tags:
        - Key: Project
          Value: InstaGO
        - Key: Name
          Value: !Join
            - ''
            - - !Ref LambdaFunctionName
              - _LambdaRole
        - Key: Environment
          Value: !Ref tagenvironment
        - Key: Owner
          Value: Monish Parekh
        - Key: InstaGO
          Value: ""
        - Key: Production
          Value: ""          
  MyRolePolicies: 
    Type: "AWS::IAM::Policy"
    DependsOn: MyRole
    Properties: 
      PolicyName: !Join 
            - ''
            - - !Ref LambdaFunctionName
              - _LambdaRole_Policy
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - ##DyanmoDB Access
            Sid: VisualEditor1
            Effect: Allow
            Action:
              - dynamodb:PutItem			  
              - dynamodb:UpdateItem
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:Query
              - dynamodb:DescribeGlobalTableSettings
              - dynamodb:DescribeGlobalTable  
            Resource:
              - arn:aws:dynamodb:ap-south-1:251899213637:table/InstaGO_prod_l1_lead_details*
              - arn:aws:dynamodb:ap-south-1:251899213637:table/InstaGO_prod_l2_meeting_details*
              - arn:aws:dynamodb:ap-south-1:251899213637:table/InstaGO_prod_h1_lead_details*
          - ##DyanmoDB Stream Access
            Sid: VisualEditor2
            Effect: Allow
            Action:
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:DescribeStream
              - dynamodb:ListStreams
            Resource:
              - arn:aws:dynamodb:ap-south-1:251899213637:table/InstaGO_prod_l1_lead_meeting*
              - arn:aws:dynamodb:ap-south-1:251899213637:table/InstaGO_prod_l1_lead_meeting/stream/*
          - ##CloudWatch access
            Sid: VisualEditor3           
            Action: cloudwatch:*
            Effect: Allow
            Resource: "*"
          - ## CloudWatch Logs access
            Sid: VisualEditor4
            Effect: Allow
            Action:
              - logs:List*
              - cloudwatch:List*			  
              - logs:List*
              - logs:GetLogRecord
              - logs:DescribeLogStreams
              - logs:DescribeSubscriptionFilters
              - logs:StartQuery
              - logs:DescribeMetricFilters
              - logs:GetLogDelivery
              - logs:CreateLogStream
              - logs:TagLogGroup
              - logs:GetLogEvents
              - logs:FilterLogEvents
              - logs:DescribeResourcePolicies
              - logs:DescribeDestinations
              - logs:DescribeQueries
              - logs:UntagLogGroup
              - logs:DescribeLogGroups
              - logs:StopQuery
              - logs:TestMetricFilter
              - logs:PutLogEvents
              - logs:CreateLogGroup
              - logs:DescribeExportTasks
              - logs:GetQueryResults
              - logs:PutRetentionPolicy
              - logs:GetLogGroupFields
            Resource: "*" 
      Roles: 
        - 
          Ref: "MyRole"
  MyLambda:
    Type: AWS::Lambda::Function
    DependsOn: MyRolePolicies
    DeletionPolicy: Retain    
    Properties:
      Environment:
        Variables:
          l1_lead_details_table: !Ref table1
          l2_meeting_details_table: !Ref table2
          h1_meeting_details_table: !Ref table3
      FunctionName: !Ref LambdaFunctionName
      Handler: lambda_function.lambda_handler
      Runtime: python3.9
      Role: {"Fn::GetAtt" : ["MyRole", "Arn"] }       
      Description: ''
      MemorySize: 128
      Timeout: 3
      Code: 
        S3Bucket: !Ref sourcecodebucketname
        S3Key: !Ref sourcecodebucketkey
      Tags:
        - Key: Project
          Value: InstaGO
        - Key: Name
          Value: !Ref LambdaFunctionName
        - Key: Environment
          Value: !Ref tagenvironment
        - Key: Owner
          Value: Monish Parekh
        - Key: Production
          Value: ""
        - Key: InstaGO
          Value: ""

  Myeventmapping:
    Type: AWS::Lambda::EventSourceMapping
    DeletionPolicy: Retain
    DependsOn: MyLambda
    Properties:
      BatchSize: 100
      Enabled: True
      StartingPosition: LATEST
      EventSourceArn:
       Fn::Join:
       - ""
       -
        -
          Fn::ImportValue: !Sub "${dynamostackname}-streamarn"
      FunctionName:
        Fn::Join:
        - ""
        -
         - "arn:aws:lambda:"
         -
           Ref: "AWS::Region"
         - ":"
         -
           Ref: "AWS::AccountId"
         - ":function:"
         - !Ref LambdaFunctionName